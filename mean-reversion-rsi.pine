//@version=6
// © ZenAndTheArtOfTrading | Cleaned & Simplified
strategy('MR System - RSI', overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=20)

// ═══════════════════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════════════════
enableLongs = input.bool(true, 'Enable Long Positions', group='Trade Direction')
enableShorts = input.bool(false, 'Enable Short Positions', group='Trade Direction')
entryStretch = input.float(0.5, 'Entry Stretch (ATR)', minval=0)
stopStretch = input.float(2.0, 'Stop Loss (ATR)', minval=0.1)

// ═══════════════════════════════════════════════════════════════════════════
// INDICATORS
// ═══════════════════════════════════════════════════════════════════════════
atr = ta.atr(25)
rsi = ta.rsi(close, 14)
rsiAvg = ta.sma(rsi, 14)
turnover = ta.sma(volume * close, 5)
sma50 = ta.sma(close, 50)

// ═══════════════════════════════════════════════════════════════════════════
// ENTRY CONDITIONS
// ═══════════════════════════════════════════════════════════════════════════
isLiquid = turnover > 1000000

// Long conditions
isUptrend = close > sma50
rsiCrossUp = ta.crossover(rsi, rsiAvg)
longSetup = isUptrend and isLiquid and rsiCrossUp and rsi < 80

// Short conditions
isDowntrend = close < sma50
rsiCrossDown = ta.crossunder(rsi, rsiAvg)
shortSetup = isDowntrend and isLiquid and rsiCrossDown and rsi > 20

noPosition = strategy.position_size == 0

// ═══════════════════════════════════════════════════════════════════════════
// TRAILING STOP LOGIC
// ═══════════════════════════════════════════════════════════════════════════
var float trailStop = na
var float extremePrice = na

justEnteredLong = strategy.position_size > 0 and strategy.position_size[1] == 0
justEnteredShort = strategy.position_size < 0 and strategy.position_size[1] == 0
inLongPosition = strategy.position_size > 0
inShortPosition = strategy.position_size < 0

// Initialize on long entry
if justEnteredLong
    trailStop := strategy.position_avg_price - (atr * stopStretch)
    extremePrice := high

// Initialize on short entry
if justEnteredShort
    trailStop := strategy.position_avg_price + (atr * stopStretch)
    extremePrice := low

// Update trailing stop for longs (only moves up)
if inLongPosition
    extremePrice := math.max(extremePrice, high)
    newStop = extremePrice - (atr * stopStretch)
    trailStop := math.max(trailStop, newStop)

// Update trailing stop for shorts (only moves down)
if inShortPosition
    extremePrice := math.min(extremePrice, low)
    newStop = extremePrice + (atr * stopStretch)
    trailStop := math.min(trailStop, newStop)

// ═══════════════════════════════════════════════════════════════════════════
// TRADE EXECUTION
// ═══════════════════════════════════════════════════════════════════════════
if longSetup and noPosition and enableLongs
    strategy.entry('Long', strategy.long)

if shortSetup and noPosition and enableShorts
    strategy.entry('Short', strategy.short)

if inLongPosition
    strategy.exit('Exit Long', 'Long', stop=trailStop)

if inShortPosition
    strategy.exit('Exit Short', 'Short', stop=trailStop)

// ═══════════════════════════════════════════════════════════════════════════
// VISUALIZATION
// ═══════════════════════════════════════════════════════════════════════════
plotshape(longSetup, 'Long Signal', shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(shortSetup, 'Short Signal', shape.triangledown, location.abovebar, color.red, size=size.small)
plot(inLongPosition or inShortPosition ? trailStop : na, 'Trailing Stop', color.yellow, 2, plot.style_linebr)
plot(sma50, '50 SMA', color.blue, 2)
